<!DOCTYPE html>
<html>
<head>
  <title>Editor - RW Mod IDE</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Inline styles removed -->
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="project_dashboard.html">Projects</a>
  </nav>

  <div class="editor-container"> <!-- Already using editor-container -->
    <div id="fileExplorer">
      <h3>Project Files</h3>
      <ul id="fileList"></ul>
    </div>
    <div class="editor-area">
      <textarea id="codeEditor" rows="20" cols="80" placeholder="Select a file to view its content..."></textarea>
      <div class="editor-controls">
        <button id="saveButton">Save File</button>
        <div id="currentFileDisplay">Editing: None</div>
        <div id="editorMessage" class="user-message"></div> <!-- Added user-message class -->
      </div>
    </div>
  </div>

  <script>
    const fileListUl = document.getElementById('fileList');
    const codeEditor = document.getElementById('codeEditor');
    const saveButton = document.getElementById('saveButton');
    const editorMessageDiv = document.getElementById('editorMessage');
    const currentFileDisplay = document.getElementById('currentFileDisplay');
    const API_BASE_URL = 'http://localhost:3000/api';

    let currentProject = '';
    let currentOpenFile = '';

    function displayEditorMessage(message, type = 'error') { // type can be 'success' or 'error'
      editorMessageDiv.textContent = message;
      // Add base class 'user-message' and type-specific class 'success' or 'error'
      editorMessageDiv.className = 'user-message ' + type; 
      editorMessageDiv.style.display = 'inline-block'; // Changed from 'block' to 'inline-block' to fit better with global styles
      
      setTimeout(() => {
        editorMessageDiv.style.display = 'none';
        editorMessageDiv.textContent = '';
        editorMessageDiv.className = 'user-message'; // Reset to base class
      }, 3000); // Hide after 3 seconds
    }

    function updateCurrentFileDisplay(filename) {
      currentOpenFile = filename;
      currentFileDisplay.textContent = `Editing: ${filename || 'None'}`;
      if (!filename) {
         codeEditor.value = ''; 
         codeEditor.placeholder = 'Select a file to view its content...';
      }
    }

    function fetchProjectFiles(projectName) {
      fileListUl.innerHTML = ''; 
      fetch(`${API_BASE_URL}/files?project=${encodeURIComponent(projectName)}`)
        .then(response => {
          if (!response.ok) { throw new Error(`HTTP error! ${response.status}`); }
          return response.json();
        })
        .then(files => { 
          if (files.length === 0) {
            fileListUl.innerHTML = '<li>No files in this project.</li>';
            return;
          }
          files.sort((a, b) => {
            if (a.isDirectory !== b.isDirectory) {
                return a.isDirectory ? -1 : 1;
            }
            return a.name.localeCompare(b.name);
          });
          
          files.forEach(file => { 
            const li = document.createElement('li');
            li.textContent = file.name;
            li.className = file.isDirectory ? 'type-directory' : 'type-file';
            
            if (file.isDirectory) {
              // Future: handle directory expansion
            } else {
              li.onclick = () => loadFileContent(projectName, file.name);
            }
            fileListUl.appendChild(li);
          });
        })
        .catch(error => displayEditorMessage(`Failed to load project files: ${error.message}`, 'error'));
    }

    function loadFileContent(projectName, fileName) {
      fetch(`${API_BASE_URL}/file?project=${encodeURIComponent(projectName)}&filename=${encodeURIComponent(fileName)}`)
        .then(response => {
          if (!response.ok) { throw new Error(`HTTP error! ${response.status}`); }
          return response.text();
        })
        .then(content => {
          codeEditor.value = content;
          codeEditor.placeholder = ''; 
          updateCurrentFileDisplay(fileName);
        })
        .catch(error => {
          displayEditorMessage(`Failed to load file '${fileName}': ${error.message}`, 'error');
          codeEditor.value = `Could not load ${fileName}.`; 
          updateCurrentFileDisplay(''); 
        });
    }

    saveButton.addEventListener('click', () => {
      if (!currentProject || !currentOpenFile) {
        displayEditorMessage('No file is currently open to save.', 'error');
        return;
      }
      const content = codeEditor.value;

      fetch(`${API_BASE_URL}/file?project=${encodeURIComponent(currentProject)}&filename=${encodeURIComponent(currentOpenFile)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(`Server error: ${text || response.statusText}`); });
        }
        return response.json();
      })
      .then(data => {
        if (data.message && data.message.toLowerCase().includes('saved')) {
          displayEditorMessage('File saved successfully!', 'success');
        } else {
          throw new Error(data.message || 'Unknown error saving file.');
        }
      })
      .catch(error => displayEditorMessage(`Failed to save file '${currentOpenFile}': ${error.message}`, 'error'));
    });

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      currentProject = params.get('project');
      if (currentProject) {
        document.title = `Editor - ${currentProject}`;
        fetchProjectFiles(currentProject);
        updateCurrentFileDisplay(''); 
      } else {
        displayEditorMessage('No project specified. Open from dashboard.', 'error');
        fileListUl.innerHTML = '<li>No project loaded.</li>';
        updateCurrentFileDisplay('');
      }
    });
  </script>
</body>
</html>