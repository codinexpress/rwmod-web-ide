<!DOCTYPE html>
<html>
<head>
  <title>Editor - RW Mod IDE</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <!-- Inline styles removed -->
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="project_dashboard.html">Projects</a>
  </nav>

  <div class="editor-container"> 
    <div id="fileExplorer">
      <h3>Project Files</h3>
      <ul id="fileList"></ul>
    </div>
    <div class="editor-area">
      <!-- Replaced textarea with this div -->
      <div id="monacoEditorContainer" style="height: 100%; width: 100%; border: 1px solid #ccc;"></div>
      <div class="editor-controls">
        <button id="saveButton">Save File</button>
        <div id="currentFileDisplay">Editing: None</div>
        <div id="editorMessage" class="user-message"></div> 
      </div>
    </div>
  </div>

  <script>
    const fileListUl = document.getElementById('fileList');
    const saveButton = document.getElementById('saveButton');
    const editorMessageDiv = document.getElementById('editorMessage');
    const currentFileDisplay = document.getElementById('currentFileDisplay');
    const API_BASE_URL = 'http://localhost:3000/api';

    let currentProject = '';
    let currentOpenFile = '';
    let editor; // Global Monaco editor instance

    function displayEditorMessage(message, type = 'error') { 
      editorMessageDiv.textContent = message;
      editorMessageDiv.className = 'user-message ' + type; 
      editorMessageDiv.style.display = 'inline-block';
      
      setTimeout(() => {
        editorMessageDiv.style.display = 'none';
        editorMessageDiv.textContent = '';
        editorMessageDiv.className = 'user-message'; 
      }, 3000); 
    }

    function updateCurrentFileDisplay(filename) {
      currentOpenFile = filename;
      currentFileDisplay.textContent = `Editing: ${filename || 'None'}`;
      if (!filename && editor) { 
         // editor.setValue(''); // Clear editor if no file is open - Handled by loadFileContent
         // editor.updateOptions({ readOnly: true }); 
      } else if (editor) {
         // editor.updateOptions({ readOnly: false });
      }
    }

    function fetchProjectFiles(projectName) {
      fileListUl.innerHTML = ''; 
      fetch(`${API_BASE_URL}/files?project=${encodeURIComponent(projectName)}`)
        .then(response => {
          if (!response.ok) { throw new Error(`HTTP error! ${response.status}`); }
          return response.json();
        })
        .then(files => { 
          if (files.length === 0) {
            fileListUl.innerHTML = '<li>No files in this project.</li>';
            return;
          }
          files.sort((a, b) => {
            if (a.isDirectory !== b.isDirectory) {
                return a.isDirectory ? -1 : 1;
            }
            return a.name.localeCompare(b.name);
          });
          
          files.forEach(file => { 
            const li = document.createElement('li');
            li.textContent = file.name;
            li.className = file.isDirectory ? 'type-directory' : 'type-file';
            
            if (file.isDirectory) {
              // Future: handle directory expansion
            } else {
              li.onclick = () => loadFileContent(projectName, file.name);
            }
            fileListUl.appendChild(li);
          });
        })
        .catch(error => displayEditorMessage(`Failed to load project files: ${error.message}`, 'error'));
    }

    function loadFileContent(projectName, fileName) {
      if (editor) editor.setValue('// Loading...'); 
      fetch(`${API_BASE_URL}/file?project=${encodeURIComponent(projectName)}&filename=${encodeURIComponent(fileName)}`)
        .then(response => {
          if (!response.ok) { throw new Error(`HTTP error! ${response.status}`); }
          return response.text();
        })
        .then(content => {
          if (editor) {
            const model = editor.getModel();
            let language = 'plaintext';
            const extension = fileName.split('.').pop().toLowerCase();
            if (extension === 'lua') language = 'lua';
            else if (extension === 'ini' || extension === 'txt') language = 'ini'; 
            else if (extension === 'json') language = 'json';
            else if (extension === 'html') language = 'html';
            else if (extension === 'css') language = 'css';
            else if (extension === 'js') language = 'javascript';
            
            if (model) { // Ensure model exists
                monaco.editor.setModelLanguage(model, language);
            }
            editor.setValue(content);
          }
          updateCurrentFileDisplay(fileName);
        })
        .catch(error => {
          displayEditorMessage(`Failed to load file '${fileName}': ${error.message}`, 'error');
          if (editor) editor.setValue(`// Could not load ${fileName}.`); 
          updateCurrentFileDisplay(''); 
        });
    }

    saveButton.addEventListener('click', () => {
      if (!currentProject || !currentOpenFile || !editor) { 
        displayEditorMessage('No file is currently open or editor not ready.', 'error');
        return;
      }
      const content = editor.getValue(); 

      fetch(`${API_BASE_URL}/file?project=${encodeURIComponent(currentProject)}&filename=${encodeURIComponent(currentOpenFile)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(`Server error: ${text || response.statusText}`); });
        }
        return response.json();
      })
      .then(data => {
        if (data.message && data.message.toLowerCase().includes('saved')) {
          displayEditorMessage('File saved successfully!', 'success');
        } else {
          throw new Error(data.message || 'Unknown error saving file.');
        }
      })
      .catch(error => displayEditorMessage(`Failed to save file '${currentOpenFile}': ${error.message}`, 'error'));
    });

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      currentProject = params.get('project');

      require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
      require(['vs/editor/editor.main'], function() {
          editor = monaco.editor.create(document.getElementById('monacoEditorContainer'), {
              value: [
                  '; Sample INI file content for syntax highlighting test',
                  '[UserSettings]',
                  'Theme = Dark',
                  'FontSize = 14',
                  'ShowToolbar = true',
                  '',
                  '[Server.Networking]',
                  'Host = 192.168.1.100',
                  'Port = 8080',
                  'TimeoutSeconds = 30 ; Connection timeout',
                  'EnableSSL = false',
                  '',
                  '[FeatureFlags]',
                  'AlphaFeatureEnabled = true ; Toggle for new alpha features',
                  'BetaFeatureAccessList = user1,user2,admin'
              ].join('\n'),
              language: 'ini', // Explicitly set to INI for this test
              theme: 'vs-dark',
              automaticLayout: true 
          });
          
          window.addEventListener('resize', () => {
              if (editor) {
                  editor.layout();
              }
          });
          
          if (currentProject) {
            document.title = `Editor - ${currentProject}`;
            fetchProjectFiles(currentProject);
            updateCurrentFileDisplay(''); 
          } else {
            // No project loaded, editor already shows default INI content.
            fileListUl.innerHTML = '<li>No project loaded. Displaying sample.</li>';
            updateCurrentFileDisplay('sample.ini (default)'); // Reflect that sample INI is shown
          }
      });
    });
  </script>
</body>
</html>