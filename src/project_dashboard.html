<!DOCTYPE html>
<html>
<head>
  <title>Project Dashboard - RW Mod IDE</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Inline styles removed -->
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="editor.html">Editor</a>
  </nav>

  <div class="container">
    <h1>Project Dashboard</h1>
    <div id="userMessage" class="user-message"></div> <!-- Ensured class user-message is present -->
    <ul id="projectList" class="project-list"></ul>

    <div class="create-project-controls">
      <h3>Create New Project</h3>
      <input type="text" id="newProjectName" placeholder="Enter new project name...">
      <button id="createProjectBtn">Create Project</button>
    </div>
  </div>

  <script>
    const projectListUl = document.getElementById('projectList');
    const newProjectNameInput = document.getElementById('newProjectName');
    const createProjectBtn = document.getElementById('createProjectBtn');
    const userMessageDiv = document.getElementById('userMessage');
    const API_BASE_URL = 'http://localhost:3000/api';

    function displayUserMessage(message, type = 'error') { // type can be 'success' or 'error'
      userMessageDiv.textContent = message;
      // Add base class 'user-message' and type-specific class 'success' or 'error'
      userMessageDiv.className = 'user-message ' + type; 
      userMessageDiv.style.display = 'block';
      
      setTimeout(() => {
        userMessageDiv.style.display = 'none';
        userMessageDiv.textContent = '';
        userMessageDiv.className = 'user-message'; // Reset to base class
      }, 5000);
    }

    function fetchAndDisplayProjects() {
      projectListUl.innerHTML = ''; 

      fetch(`${API_BASE_URL}/projects`)
        .then(response => {
          if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
          return response.json();
        })
        .then(projects => {
          if (projects.length === 0) {
            projectListUl.innerHTML = '<li class="project-item">No projects found. Create one!</li>';
            return;
          }
          projects.forEach(projectName => {
            const li = document.createElement('li');
            li.className = 'project-item'; 
            const nameSpan = document.createElement('span');
            nameSpan.className = 'project-item-name';
            nameSpan.textContent = projectName;
            li.appendChild(nameSpan);
            
            li.onclick = () => {
              window.location.href = `editor.html?project=${encodeURIComponent(projectName)}`;
            };
            projectListUl.appendChild(li);
          });
        })
        .catch(error => {
          displayUserMessage(`Failed to load projects: ${error.message}`, 'error');
        });
    }

    createProjectBtn.addEventListener('click', () => {
      const projectName = newProjectNameInput.value.trim();
      if (!projectName) {
        displayUserMessage('Project name cannot be empty.', 'error');
        return;
      }

      fetch(`${API_BASE_URL}/file?project=${encodeURIComponent(projectName)}&filename=.project_created_marker`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', },
        body: JSON.stringify({ content: '' })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(`Server error: ${text || response.statusText}`); });
        }
        return response.json();
      })
      .then(data => {
        if (data.message && data.message.toLowerCase().includes('saved')) {
          displayUserMessage(`Project '${projectName}' created successfully!`, 'success');
          newProjectNameInput.value = ''; 
          fetchAndDisplayProjects(); 
        } else {
          throw new Error(data.message || 'Unknown error creating project marker.');
        }
      })
      .catch(error => {
        displayUserMessage(`Failed to create project '${projectName}': ${error.message}`, 'error');
      });
    });

    // Initial load
    fetchAndDisplayProjects();
  </script>
</body>
</html>
